# 3.3. THIẾT KẾ LUỒNG XỬ LÝ (ACTIVITY DIAGRAM)

## 3.3.1. Luồng xử lý chính - MedFlow

Hệ thống sử dụng **PocketFlow** làm nền tảng xử lý luồng (Workflow Engine). Luồng chính `MedFlow` được thiết kế theo kiến trúc hướng sự kiện, với `RagAgent` đóng vai trò trung tâm điều phối và `MemoryManager` quản lý bộ nhớ dài hạn.

### Activity Diagram (Medical Conversation Flow)

```mermaid
graph TD
    Start((Start)) --> Ingest[IngestQuery]
    Ingest --> RetrieveMem[RetrieveFromMemory]
    RetrieveMem --> Decide[DecideSummarizeConversation<br>ToRetriveOrDirectlyAnswer]

    %% Main Decision
    Decide -- "retrieve_kb" --> RagAgent[RagAgent]
    Decide -- "default" --> MemoryMgr[MemoryManager]

    %% RagAgent Paths
    RagAgent -- "create_retrieval_query" --> CreateQuery[QueryCreatingFor<br>RetrievalAgent]
    CreateQuery --> RetrieveKB[RetrieveFromKBWithDemuc]

    RagAgent -- "retrieve_kb" --> TopicClassify[TopicClassifyAgent]
    TopicClassify --> RetrieveKB

    RagAgent -- "compose_answer" --> Compose[ComposeAnswer]

    %% Retrieval Logic
    RetrieveKB -- "compose" --> Compose
    RetrieveKB -- "loop" --> RagAgent

    %% Compose Logic
    Compose --> MemoryMgr

    %% Memory Management (Worker Nodes)
    MemoryMgr -- "default" --> AddMem[AddMemory]
    AddMem --> UpdateMem[UpdateMemory]
    UpdateMem --> DeleteMem[DeleteMemory]
    DeleteMem --> End((End))

    MemoryMgr -- "skip" --> End

    %% Fallback
    Decide -.-> Fallback[FallbackNode]
    RagAgent -.-> Fallback
    Compose -.-> Fallback
    CreateQuery -.-> Fallback
    Fallback --> End
```

### Mô tả chi tiết các Node

| Node | Chức năng | Input/Output chính |
| :--- | :--- | :--- |
| **IngestQuery** | Tiếp nhận request, khởi tạo session, chuẩn hóa input. | In: `query`, `user_id`<br>Out: `normalized_query` |
| **RetrieveFromMemory** | Tìm kiếm thông tin liên quan từ `user_memory` (Qdrant) dựa trên query hiện tại. | Out: `relevant_memories` |
| **DecideSummarize...** | LLM Router quyết định: trả lời ngay (chào hỏi) hay cần RAG (hỏi bệnh). | Out: `action` ("retrieve_kb" / "default") |
| **RagAgent** | Agent trung tâm điều phối chiến lược RAG. Phân tích ngữ cảnh để chọn: tạo query mới, phân loại chủ đề, hay trả lời luôn. | In: `rag_history`, `context`<br>Out: `rag_action` |
| **QueryCreating...** | (Optional) Viết lại câu truy vấn tốt hơn để tăng độ chính xác tìm kiếm vector. | Out: `retrieval_query` |
| **TopicClassifyAgent** | Phân loại câu hỏi vào danh mục y khoa (DEMUC) để lọc dữ liệu tìm kiếm. | Out: `demuc` |
| **RetrieveFromKB...** | Thực hiện Hybrid Search (Dense + Sparse + ColBERT) vào Knowledge Base. | Out: `kb_context` |
| **ComposeAnswer** | Tổng hợp câu trả lời cuối cùng từ Context và Memory. | Out: `final_answer` |
| **MemoryManager** | Phân tích hội thoại để xác định các thao tác cần làm với bộ nhớ (Insert/Update/Delete). | Out: `memory_operations` |
| **Add/Update/DeleteMemory** | Các worker nodes thực thi thao tác cụ thể lên Qdrant `user_memory`. | - |

---

## 3.3.2. Các luồng phụ (Sub-flows)

### a. Luồng Authentication (Xác thực)

```mermaid
sequenceDiagram
    participant User
    participant API as Auth API
    participant DB as PostgreSQL

    User->>API: Login Request (Email/Password)
    API->>DB: Query User by Email
    DB-->>API: User Data + Hashed Password
    API->>API: Verify Password (bcrypt)

    alt Login Success
        API->>API: Generate JWT Token
        API-->>User: Return Access Token
    else Login Failed
        API-->>User: 401 Unauthorized
    end
```

### b. Luồng Load Embeddings (Knowledge Base)

Quy trình nạp dữ liệu y khoa từ CSV vào Qdrant với chiến lược Hybrid Search.

```mermaid
graph LR
    CSV[CSV Source] --> Load[Load Script]
    Load --> Embed[Embedding Models]

    subgraph "Hybrid Embedding Generation"
        Embed --> Dense[Dense: MiniLM-L6-v2]
        Embed --> Sparse[Sparse: BM25]
        Embed --> Late[Late: ColBERTv2.0]
    end

    Dense & Sparse & Late --> Upsert[Upsert to Qdrant]
    Upsert --> Collection[Vector Collection]
```

### c. Luồng Memory Management (Chi tiết)

Cách `MemoryManager` điều phối việc lưu trữ thông tin người dùng.

```mermaid
flowchart TD
    Input[Conversation] --> Mgr[MemoryManager]
    Mgr --> Analyze{Analyze Content}

    Analyze -->|New Info| PlanAdd[Plan: INSERT]
    Analyze -->|Changed Info| PlanUpd[Plan: UPDATE]
    Analyze -->|Wrong Info| PlanDel[Plan: DELETE]

    PlanAdd & PlanUpd & PlanDel --> Exec[Worker Nodes Execution]

    Exec --> Add[AddMemory Node]
    Add --> Upd[UpdateMemory Node]
    Upd --> Del[DeleteMemory Node]

    Del --> Done([Finish])
```
