# 3.4. THIẾT KẾ SEQUENCE DIAGRAM (BIỂU ĐỒ TUẦN TỰ)

Mục này mô tả chi tiết sự tương tác giữa các đối tượng trong hệ thống theo thời gian cho các chức năng quan trọng.

## 3.4.1. Sequence: User Chat Flow (Luồng Chat Tổng Quát)

Mô tả luồng tương tác từ khi người dùng gửi tin nhắn đến khi nhận được câu trả lời.

```mermaid
sequenceDiagram
    autonumber
    actor User
    participant FE as Frontend/Client
    participant API as Chat API (FastAPI)
    participant DB as PostgreSQL
    participant Flow as PocketFlow (MedFlow)
    participant Nodes as Flow Nodes
    participant Qdrant as Vector DB
    participant Gemini as LLM Service

    User->>FE: Gửi câu hỏi ("Tôi bị đau đầu...")
    FE->>API: POST /api/chat (query, thread_id)
    activate API

    API->>API: Validate Token (Middleware)
    API->>DB: Save User Message

    API->>Flow: Run MedFlow(query)
    activate Flow

    Flow->>Nodes: IngestQuery (Normalize)
    Flow->>Qdrant: Retrieve User Memory
    Qdrant-->>Flow: Historical Context

    Flow->>Nodes: DecideSummarize... (LLM Router)
    Nodes->>Gemini: Analyze Intent
    Gemini-->>Nodes: "retrieve_kb" or "default"

    alt Needs RAG (retrieve_kb)
        Flow->>Nodes: RagAgent Execution
        Nodes->>Qdrant: Hybrid Search (Knowledge Base)
        Qdrant-->>Nodes: Medical Docs
        Nodes->>Gemini: Generate Answer with Context
        Gemini-->>Nodes: Final Answer
    else Direct Answer (default)
        Nodes->>Gemini: Generate Friendly Response
        Gemini-->>Nodes: Response
    end

    Flow->>Nodes: MemoryManager (Analyze & Plan)
    Nodes->>Qdrant: Update User Memory (Async)

    Flow-->>API: Return Final Answer
    deactivate Flow

    API->>DB: Save Bot Message
    API-->>FE: JSON Response (Answer, Sources)
    deactivate API

    FE-->>User: Hiển thị câu trả lời
```

## 3.4.2. Sequence: RAG Retrieval Flow (Chi tiết luồng RAG)

Mô tả chi tiết các bước bên trong `RagAgent` và các node liên quan khi thực hiện truy vấn kiến thức y khoa.

```mermaid
sequenceDiagram
    autonumber
    participant Main as MedFlow
    participant RagAgent as RagAgent Node
    participant Topic as TopicClassifyAgent
    participant QueryGen as QueryCreatingAgent
    participant Retr as RetrieveFromKB Node
    participant Qdrant as Qdrant DB
    participant LLM as Gemini API

    Main->>RagAgent: Invoke (Context, History)
    activate RagAgent

    RagAgent->>LLM: Analyze Context & Decide Strategy
    LLM-->>RagAgent: Strategy (e.g., "create_retrieval_query")

    alt Strategy: New Query
        RagAgent->>QueryGen: Generate Optimized Query
        QueryGen->>LLM: Rewrite Query
        LLM-->>QueryGen: "Dấu hiệu bệnh đau nửa đầu?"
        QueryGen->>Retr: Retrieve with New Query
    else Strategy: Classify Topic
        RagAgent->>Topic: Classify DEMUC
        Topic->>LLM: Classify (Nội thần kinh...)
        LLM-->>Topic: DEMUC="Nội thần kinh"
        Topic->>Retr: Retrieve with DEMUC filter
    end

    activate Retr
    Retr->>Qdrant: Hybrid Search (Dense + Sparse + ColBERT)
    Qdrant-->>Retr: Top-k Documents
    Retr->>Retr: Check Confidence / Re-ranking
    Retr-->>Main: Context Documents
    deactivate Retr

    Main->>Main: Check Loop Condition

    Main->>ComposeAnswer: Generate Final Answer
    activate ComposeAnswer
    ComposeAnswer->>LLM: Prompt (Query + Context + Memory)
    LLM-->>ComposeAnswer: "Theo tài liệu, bạn nên..."
    ComposeAnswer-->>Main: Final Text
    deactivate ComposeAnswer

    deactivate RagAgent
```

## 3.4.3. Sequence: Authentication Flow (Đăng nhập)

Mô tả quá trình đăng nhập sử dụng Email và Password (PostgreSQL only).

```mermaid
sequenceDiagram
    autonumber
    actor User
    participant FE as Client App
    participant Auth as Auth API
    participant DB as PostgreSQL
    participant Utils as Crypto Utils

    User->>FE: Nhập Email & Password
    FE->>Auth: POST /api/auth/login
    activate Auth

    Auth->>DB: Query User by Email
    DB-->>Auth: User Record (Found)

    alt User Not Found
        Auth-->>FE: 401 Unauthorized
    else User Found
        Auth->>Utils: Verify Password (Input, Hash)
        Utils-->>Auth: Result (True/False)

        alt Password Invalid
            Auth-->>FE: 401 Unauthorized
        else Password Valid
            Auth->>Utils: Create Access Token (JWT)
            Utils-->>Auth: Token String

            Auth-->>FE: 200 OK (Token, User Info)
        end
    end
    deactivate Auth

    FE->>FE: Save Token to LocalStorage
```

## 3.4.4. Sequence: Embedding Load Flow (Nạp dữ liệu)

Mô tả quá trình Admin nạp dữ liệu từ file CSV vào Vector Database.

```mermaid
sequenceDiagram
    autonumber
    actor Admin
    participant API as Embedding API
    participant Script as Load Script
    participant Models as Embedding Models
    participant Qdrant as Qdrant DB

    Admin->>API: POST /api/embeddings/load (files)
    activate API

    API->>Script: Trigger Background Task
    API-->>Admin: 202 Accepted (Task Started)
    deactivate API

    activate Script
    Script->>Script: Load CSV Files
    Script->>Models: Load Models (MiniLM, BM25, ColBERT)

    loop For each row in CSV
        Script->>Script: Preprocess Text (Clean, Expand Abbr)

        par Generate Embeddings
            Script->>Models: Generate Dense Vector
            Script->>Models: Generate Sparse Vector
            Script->>Models: Generate ColBERT Vector
        end

        Models-->>Script: Vectors
        Script->>Script: Create PointStruct
    end

    Script->>Qdrant: Upsert Points (Batch)
    Qdrant-->>Script: Success/Fail

    Script->>Script: Log Results
    deactivate Script
```
