# 3.2. THIẾT KẾ USE CASE

## 3.2.1. Use Case Diagram

Sơ đồ Use Case tổng quan mô tả các tác nhân (actors) và các chức năng chính của hệ thống Chatbot Y tế.

```mermaid
usecaseDiagram
    actor "User (Patient)" as User
    actor "System Admin" as Admin
    actor "Medical Expert" as Expert

    package "Medical Chatbot System" {
        usecase "Đăng nhập / Đăng ký" as UC1
        usecase "Tạo cuộc trò chuyện mới" as UC2
        usecase "Gửi câu hỏi y tế (Chat)" as UC3
        usecase "Xem lịch sử hội thoại" as UC5
        usecase "Quản lý Knowledge Base" as UC6
        usecase "Nạp dữ liệu Embeddings" as UC4
    }

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC5

    Admin --> UC1
    Admin --> UC4

    Expert --> UC6
    UC6 ..> UC4 : include

    note right of UC3
        Sử dụng kỹ thuật RAG
        (Retrieval Augmented Generation)
    end note
```

### Các tác nhân (Actors):
*   **User (Patient):** Người dùng cuối, sử dụng hệ thống để đặt câu hỏi về sức khỏe và nhận tư vấn.
*   **System Admin:** Quản trị viên hệ thống, chịu trách nhiệm vận hành kỹ thuật, nạp dữ liệu (embeddings) vào Vector DB.
*   **Medical Expert:** Chuyên gia y tế, người biên soạn và chuẩn hóa dữ liệu kiến thức (CSV) để đưa vào hệ thống.

---

## 3.2.2. Mô tả chi tiết các Use Case chính

Dưới đây là chi tiết các luồng xử lý cho các chức năng quan trọng nhất của hệ thống.

### UC1: Đăng nhập hệ thống

| Đặc tả Use Case | Chi tiết |
| :--- | :--- |
| **Use Case ID** | UC1 |
| **Use Case Name** | Đăng nhập hệ thống |
| **Actor** | User, System Admin |
| **Precondition** | Tài khoản đã được đăng ký. |
| **Main Flow** | 1. User truy cập vào giao diện đăng nhập.<br>2. User nhập Email và Password.<br>3. Hệ thống gửi yêu cầu xác thực đến API (`/api/auth/login`).<br>4. Hệ thống kiểm tra thông tin xác thực trong DB.<br>5. Hệ thống tạo JWT Access Token.<br>6. Hệ thống trả về Token và thông tin User.<br>7. Ứng dụng client lưu Token và chuyển hướng vào màn hình chính. |
| **Alternative Flow** | **3a. Sai thông tin đăng nhập:**<br>1. Hệ thống trả về lỗi 401 Unauthorized.<br>2. Hiển thị thông báo lỗi cho User.<br>3. User nhập lại thông tin. |
| **Postcondition** | User có phiên làm việc hợp lệ (JWT Token) để gọi các API bảo mật. |

### UC2: Tạo thread trò chuyện

| Đặc tả Use Case | Chi tiết |
| :--- | :--- |
| **Use Case ID** | UC2 |
| **Use Case Name** | Tạo thread trò chuyện mới |
| **Actor** | User |
| **Precondition** | User đã đăng nhập thành công (có JWT Token). |
| **Main Flow** | 1. User nhấn nút "Cuộc trò chuyện mới" trên giao diện.<br>2. Client gửi request `POST /api/threads` (có thể kèm tiêu đề hoặc rỗng).<br>3. Hệ thống tạo một UUID mới cho Thread.<br>4. Hệ thống lưu bản ghi Thread vào PostgreSQL liên kết với User ID hiện tại.<br>5. Hệ thống trả về thông tin Thread (ID, Name, CreatedAt). |
| **Alternative Flow** | **2a. Lỗi kết nối CSDL:**<br>1. Hệ thống trả về lỗi 500.<br>2. Client hiển thị thông báo "Không thể tạo cuộc trò chuyện". |
| **Postcondition** | Một thread mới được tạo ra, sẵn sàng để lưu trữ các message chat. |

### UC3: Hỏi đáp y tế với RAG

| Đặc tả Use Case | Chi tiết |
| :--- | :--- |
| **Use Case ID** | UC3 |
| **Use Case Name** | Hỏi đáp y tế với RAG (Retrieval Augmented Generation) |
| **Actor** | User |
| **Precondition** | User đã đăng nhập và đang ở trong một Thread active. |
| **Main Flow** | 1. User nhập câu hỏi y tế và nhấn gửi.<br>2. Client gửi request `POST /api/chat` với nội dung câu hỏi và `thread_id`.<br>3. **Flow Engine (PocketFlow)** kích hoạt quy trình xử lý:<br>&nbsp;&nbsp;a. **IngestQuery:** Nhận và chuẩn hóa câu hỏi.<br>&nbsp;&nbsp;b. **RetrieveFromMemory:** Tìm kiếm ngữ cảnh từ lịch sử hội thoại cũ (Qdrant User Memory).<br>&nbsp;&nbsp;c. **TopicClassify:** Phân loại chủ đề câu hỏi.<br>&nbsp;&nbsp;d. **RagAgent:** Thực hiện Query Expansion để tối ưu hóa tìm kiếm.<br>&nbsp;&nbsp;e. **RetrieveFromKB:** Truy vấn Vector DB (Qdrant) để tìm kiến thức y khoa liên quan (Hybrid Search: Dense + Sparse + ColBERT).<br>&nbsp;&nbsp;f. **ComposeAnswer:** LLM (Gemini) tổng hợp thông tin từ Context và Memory để sinh câu trả lời.<br>&nbsp;&nbsp;g. **SaveToMemory:** Lưu câu hỏi và câu trả lời mới vào Memory.<br>4. Hệ thống lưu message của User và Bot vào PostgreSQL.<br>5. Hệ thống trả về câu trả lời cho Client. |
| **Alternative Flow** | **3e-Alt. Không tìm thấy thông tin:**<br>1. Nếu điểm tin cậy (confidence score) của việc tìm kiếm quá thấp.<br>2. LLM sẽ trả lời dựa trên kiến thức nội tại hoặc yêu cầu User cung cấp thêm thông tin, kèm cảnh báo "Thông tin này chưa được kiểm chứng trong tài liệu y khoa của hệ thống".<br><br>**3-Error. Lỗi hệ thống (LLM overload/Network):**<br>1. Flow kích hoạt **FallbackNode**.<br>2. Trả về thông báo lỗi thân thiện: "Hệ thống đang bận, vui lòng thử lại sau". |
| **Postcondition** | User nhận được câu trả lời; Lịch sử hội thoại được cập nhật; Memory được cập nhật. |

### UC4: Quản lý dữ liệu embedding

| Đặc tả Use Case | Chi tiết |
| :--- | :--- |
| **Use Case ID** | UC4 |
| **Use Case Name** | Quản lý và nạp dữ liệu Embedding |
| **Actor** | System Admin |
| **Precondition** | Các file dữ liệu chuẩn (CSV) đã được chuẩn bị sẵn trong thư mục source code; Qdrant service đang chạy. |
| **Main Flow** | 1. Admin gửi request `POST /api/embeddings/load` (có thể chỉ định load lại toàn bộ hoặc update).<br>2. Hệ thống đọc cấu hình các Collection (bệnh học, thuốc, phác đồ...).<br>3. Hệ thống tải các mô hình Embedding (Dense, BM25, ColBERT).<br>4. Với mỗi file dữ liệu:<br>&nbsp;&nbsp;a. Đọc và làm sạch dữ liệu.<br>&nbsp;&nbsp;b. Chia nhỏ (chunking) văn bản.<br>&nbsp;&nbsp;c. Tạo vector embeddings.<br>&nbsp;&nbsp;d. Upsert vào Qdrant Vector DB.<br>5. Hệ thống trả về báo cáo trạng thái (Số lượng vector đã load, trạng thái thành công/thất bại). |
| **Alternative Flow** | **4-Error. Lỗi kết nối Qdrant:**<br>1. Hệ thống báo lỗi 503 Service Unavailable.<br>2. Admin kiểm tra lại Docker container của Qdrant.<br><br>**4-Error. Lỗi định dạng dữ liệu:**<br>1. Hệ thống bỏ qua file lỗi và log lại warning.<br>2. Tiếp tục xử lý các file khác. |
| **Postcondition** | Dữ liệu kiến thức mới nhất được cập nhật vào Vector DB, sẵn sàng cho UC3 khai thác. |
