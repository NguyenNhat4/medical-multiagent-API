# 3.1. TỔNG QUAN KIẾN TRÚC HỆ THỐNG

Hệ thống **Medical Chatbot** được thiết kế dựa trên kiến trúc microservices đơn giản hóa (modular monolith), tập trung vào khả năng mở rộng, dễ bảo trì và tích hợp mạnh mẽ với các mô hình ngôn ngữ lớn (LLM) để xử lý hội thoại y tế. Hệ thống phân tách rõ ràng giữa các tầng xử lý yêu cầu, xử lý nghiệp vụ (workflow) và lưu trữ dữ liệu.

## 3.1.1. Mô hình tổng quan

### Sơ đồ kiến trúc tổng thể (High-level Architecture Diagram)

Dưới đây là sơ đồ kiến trúc mức cao của hệ thống, thể hiện sự tương tác giữa Người dùng, API Gateway, Engine xử lý chính và các thành phần dữ liệu/AI.

```mermaid
graph TD
    User[End User / Client App] -->|HTTP/REST| APIGateway[API Gateway / FastAPI Server]

    subgraph "Application Server"
        APIGateway -->|Route Request| AuthLayer[Authentication Layer]
        AuthLayer -->|Validated Request| ChatController[Chat Controller]

        ChatController -->|Invoke| FlowEngine[Processing Engine (PocketFlow)]

        subgraph "MedFlow (Medical Logic)"
            Ingest[Ingest Query] --> MemoryRet[Retrieve Memory]
            MemoryRet --> Decision[Decision Agent]
            Decision -->|Direct| Compose[Compose Answer]
            Decision -->|RAG| RagAgent[RAG Agent]

            RagAgent -->|Query| VectorSearch[Vector Search Node]
            VectorSearch -->|Context| Compose
            Compose --> SaveMem[Save Memory]
        end

        FlowEngine --> MedFlow
    end

    subgraph "Data Layer"
        PostgreSQL[(PostgreSQL\nUser, Threads, Messages)]
        Qdrant[(Qdrant Vector DB\nMedical KB, Embeddings)]
        UserMemory[(Qdrant Memory Collection)]
    end

    subgraph "External AI Services"
        Gemini[Google Gemini API\n(LLM)]
        EmbedModel[Embedding Models\n(HuggingFace/Local)]
    end

    FlowEngine <-->|Read/Write| PostgreSQL
    VectorSearch <-->|Similarity Search| Qdrant
    SaveMem -->|Upsert| UserMemory

    MedFlow <-->|Inference| Gemini
    MedFlow <-->|Embed| EmbedModel
```

### Các tầng trong hệ thống

Hệ thống được tổ chức thành 3 tầng chính (3-tier architecture):

1.  **API Layer (Presentation/Interface Layer)**:
    *   **Nhiệm vụ**: Tiếp nhận các yêu cầu HTTP từ client, xác thực người dùng (Authentication), kiểm tra dữ liệu đầu vào (Validation) và điều hướng yêu cầu đến các service tương ứng.
    *   **Thành phần**: `FastAPI` router, Pydantic schemas, Middleware xử lý lỗi và logging.

2.  **Service/Flow Layer (Business Logic Layer)**:
    *   **Nhiệm vụ**: Chứa toàn bộ logic nghiệp vụ của ứng dụng. Điểm đặc biệt của hệ thống là việc sử dụng **PocketFlow** để quản lý các luồng hội thoại phức tạp dưới dạng đồ thị các node (Graph-based Workflow).
    *   **Thành phần**: `MedFlow`, các Node xử lý (RAG Agent, Topic Classifier, Answer Composer), tích hợp LLM.

3.  **Data Layer (Persistence Layer)**:
    *   **Nhiệm vụ**: Lưu trữ dữ liệu bền vững và dữ liệu vector phục vụ tìm kiếm ngữ nghĩa.
    *   **Thành phần**:
        *   **PostgreSQL**: Lưu trữ thông tin người dùng, phiên đăng nhập, lịch sử hội thoại (threads, messages).
        *   **Qdrant**: Lưu trữ vector embeddings của kiến thức y khoa (Knowledge Base) và bộ nhớ người dùng (User Memory).

### Luồng dữ liệu chính (Main Data Flow)

1.  **Request**: User gửi câu hỏi -> API Gateway tiếp nhận -> Xác thực qua JWT.
2.  **Processing**: Yêu cầu được chuyển tới `MedFlow`.
3.  **Memory Lookup**: Hệ thống truy vấn `UserMemory` trong Qdrant để lấy ngữ cảnh quá khứ.
4.  **Decision**: LLM phân tích câu hỏi + ngữ cảnh để quyết định trả lời ngay hoặc cần tra cứu kiến thức (RAG).
5.  **Retrieval (nếu cần)**:
    *   Hệ thống tạo vector embedding cho câu hỏi.
    *   Truy vấn `KnowledgeBase` trong Qdrant để tìm tài liệu y khoa liên quan (Hybrid Search: Dense + Sparse).
6.  **Generation**: LLM tổng hợp thông tin từ kiến thức nền và ngữ cảnh để sinh câu trả lời.
7.  **Memory Save**: Câu hỏi và câu trả lời mới được lưu lại vào `UserMemory`.
8.  **Response**: API trả về câu trả lời cho User.

---

## 3.1.2. Các thành phần chính

### 1. API Gateway (FastAPI Server)
Là cổng giao tiếp duy nhất của hệ thống với thế giới bên ngoài.
*   **Chức năng**: Routing, Rate limiting, CORS handling, Request/Response validation.
*   **Đặc điểm**: Hiệu năng cao (Asynchronous), tự động sinh tài liệu (Swagger UI/OpenAPI).

### 2. Processing Engine (PocketFlow)
Trái tim của hệ thống chatbot, quản lý vòng đời của một yêu cầu hội thoại.
*   **PocketFlow**: Framework workflow tùy chỉnh giúp định nghĩa luồng xử lý dưới dạng Directed Acyclic Graph (DAG) hoặc Cyclic Graph.
*   **Nodes**: Các đơn vị xử lý nhỏ (Atomic units), ví dụ: `TopicClassifyAgent` (phân loại chủ đề), `RetrieveFromKB` (tra cứu), `ComposeAnswer` (soạn thảo).
*   **Flows**: `MedFlow` (luồng tư vấn y tế), `OQAFlow` (luồng chuyên khoa chỉnh nha).

### 3. Data Storage
*   **PostgreSQL (Relational DB)**:
    *   Quản lý `Users`: Thông tin tài khoản, mật khẩu (hash).
    *   Quản lý `Threads`: Các cuộc hội thoại.
    *   Quản lý `ChatMessages`: Nội dung chi tiết từng tin nhắn.
*   **Qdrant (Vector DB)**:
    *   **Collections**: `bndtd` (Bệnh nhân đái tháo đường), `bsrhm` (Bác sĩ RHM), `user_memory` (Bộ nhớ người dùng).
    *   **Search**: Hỗ trợ tìm kiếm Semantic (Cosine Similarity) kết hợp từ khóa (BM25) và Reranking (ColBERT).

### 4. AI/ML Components
*   **LLM (Large Language Model)**: Sử dụng **Google Gemini** (thông qua `google-genai` SDK) làm bộ não chính cho việc hiểu ngôn ngữ, suy luận logic và sinh văn bản.
*   **Embedding Models**:
    *   Dense: `sentence-transformers/all-MiniLM-L6-v2` (tạo vector ngữ nghĩa).
    *   Sparse: `Qdrant/bm25` (tạo vector từ khóa).
    *   Late Interaction: `colbert-ir/colbertv2.0` (mô hình reranking độ chính xác cao).

### 5. Authentication
*   Sử dụng cơ chế **JWT (JSON Web Token)**.
*   **Flow**: User đăng nhập -> Server trả về Access Token -> Client gửi Token trong Header `Authorization: Bearer <token>` cho các request tiếp theo.

---

## 3.1.3. Công nghệ và framework

Bảng dưới đây tóm tắt các công nghệ lõi được sử dụng để xây dựng hệ thống:

| Thành phần | Công nghệ / Framework | Phiên bản (Ước tính) | Lý do lựa chọn |
| :--- | :--- | :--- | :--- |
| **Backend Language** | **Python** | 3.11+ | Hệ sinh thái AI/ML mạnh mẽ, cú pháp rõ ràng, hỗ trợ tốt cho xử lý bất đồng bộ. |
| **Web Framework** | **FastAPI** | 0.111.0 | Hiệu năng cao (Starlette), validate dữ liệu mạnh (Pydantic), hỗ trợ Async IO tối ưu cho AI services. |
| **Workflow Engine** | **PocketFlow** | 0.0.3 | Framework nội bộ/tùy chỉnh giúp linh hoạt trong việc thiết kế luồng hội thoại phức tạp (Stateful LLM flows). |
| **Vector Database** | **Qdrant** | Latest (Docker) | Open-source, hiệu năng truy vấn vector cực nhanh, hỗ trợ Hybrid Search và lọc metadata tốt. |
| **Relational DB** | **PostgreSQL** | 15-alpine | Cơ sở dữ liệu quan hệ mạnh mẽ, ổn định, chuẩn công nghiệp cho lưu trữ dữ liệu người dùng. |
| **LLM Provider** | **Google GenAI** | 0.8.0 | Tích hợp mô hình Gemini: chi phí hợp lý, context window lớn, khả năng suy luận tốt tiếng Việt. |
| **Containerization** | **Docker & Compose** | - | Đóng gói môi trường nhất quán, dễ dàng triển khai và mở rộng (Microservices ready). |
| **ORM** | **SQLAlchemy** | Latest | Trừu tượng hóa thao tác với Database, an toàn và dễ bảo trì code. |

Hệ thống được thiết kế để chạy trên môi trường Container (Docker), đảm bảo tính nhất quán giữa môi trường phát triển (Development) và triển khai (Production).
